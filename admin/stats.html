<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Statistiques - Silence √ßa mijote</title>
<link rel="stylesheet" href="../style.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- pour les graphiques -->
</head>
<body>
<header class="site-header">
  <h1>Statistiques</h1>
  <a href="index.html" class="btn-liste-courses">Retour Admin</a>
</header>

<main class="container">
  <section class="blurb">
    <h2>Vue globale</h2>
    <div style="display:flex;gap:20px;flex-wrap:wrap">
      <div class="subscriber-badge" id="totalAbonnes">Abonn√©s : 0</div>
      <div class="subscriber-badge" id="totalVisites">Visites totales : 0</div>
    </div>
  </section>

  <section class="blurb">
    <h2>Visites par recette</h2>
    <canvas id="visitesRecetteChart" height="200"></canvas>
  </section>

  <section class="blurb">
    <h2>Recettes par cat√©gorie</h2>
    <canvas id="categorieChart" height="200"></canvas>
  </section>

  <section class="blurb">
    <h2>Recettes les mieux not√©es</h2>
    <canvas id="topNotesChart" height="200"></canvas>
  </section>

  <section class="blurb">
    <h2>Recettes les plus vues</h2>
    <canvas id="topVisitesChart" height="200"></canvas>
  </section>
</main>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://ttkgzzamsfnittbqqvft.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0a2d6emFtc2ZuaXR0YnFxdmZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4Mjg4MTEsImV4cCI6MjA3MDQwNDgxMX0.aE5GxrKrNJoqr1g8ASVG9Vdf7k_OLuyCOe2vZAp0-wY'
const supabase = createClient(supabaseUrl, supabaseKey)

async function loadStats() {
  // üìå Abonn√©s
  const { count: nbAbonnes } = await supabase.from('abonnes').select('email', { count: 'exact' })
  document.getElementById('totalAbonnes').innerText = `Abonn√©s : ${nbAbonnes}`

  // üìå Recettes
  const { data: recettes } = await supabase.from('recettes').select('*')
  
  // Visites totales (on suppose que tu as un champ nombre_visites dans recettes)
  const totalVisites = recettes.reduce((sum, r) => sum + (r.nombre_visites || 0), 0)
  document.getElementById('totalVisites').innerText = `Visites totales : ${totalVisites}`

  // ‚úÖ Graphiques
  const ctxRecettes = document.getElementById('visitesRecetteChart').getContext('2d')
  new Chart(ctxRecettes, {
    type: 'bar',
    data: {
      labels: recettes.map(r => r.titre),
      datasets: [{ label: 'Visites', data: recettes.map(r => r.nombre_visites || 0), backgroundColor: '#b04a32' }]
    },
    options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
  })

  // Cat√©gorie
  const categories = {}
  recettes.forEach(r => {
    const cat = r.categorie || 'Autre'
    categories[cat] = (categories[cat] || 0) + 1
  })
  const ctxCat = document.getElementById('categorieChart').getContext('2d')
  new Chart(ctxCat, {
    type:'pie',
    data:{
      labels:Object.keys(categories),
      datasets:[{data:Object.values(categories), backgroundColor:['#b04a32','#2a4d69','#2a9d8f','#f39c12','#f4d03f'] }]
    }
  })

  // Top recettes par note
  const topNotes = recettes.sort((a,b)=> (b.note_moyenne||0) - (a.note_moyenne||0)).slice(0,5)
  const ctxTopNotes = document.getElementById('topNotesChart').getContext('2d')
  new Chart(ctxTopNotes,{
    type:'bar',
    data:{
      labels: topNotes.map(r=>r.titre),
      datasets:[{label:'Note moyenne', data: topNotes.map(r=>r.note_moyenne||0), backgroundColor:'#2a4d69'}]
    },
    options:{responsive:true, scales:{y:{beginAtZero:true,max:5}}}
  })

  // Top recettes par visites
  const topVisites = recettes.sort((a,b)=> (b.nombre_visites||0) - (a.nombre_visites||0)).slice(0,5)
  const ctxTopVisites = document.getElementById('topVisitesChart').getContext('2d')
  new Chart(ctxTopVisites,{
    type:'bar',
    data:{
      labels: topVisites.map(r=>r.titre),
      datasets:[{label:'Visites', data: topVisites.map(r=>r.nombre_visites||0), backgroundColor:'#2a9d8f'}]
    },
    options:{responsive:true, scales:{y:{beginAtZero:true}}}
  })
}

loadStats()
</script>
</body>
</html>
