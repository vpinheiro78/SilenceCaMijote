<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://ttkgzzamsfnittbqqvft.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0a2d6emFtc2ZuaXR0YnFxdmZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4Mjg4MTEsImV4cCI6MjA3MDQwNDgxMX0.aE5GxrKrNJoqr1g8ASVG9Vdf7k_OLuyCOe2vZAp0-wY'
const supabase = createClient(supabaseUrl, supabaseKey)

const form = document.getElementById('recipeForm')
const listDiv = document.getElementById('list')
const uploadBtn = document.getElementById('uploadBtn')
const uploadStatus = document.getElementById('uploadStatus')

let uploadedPath = ''

// ===== Upload image =====
uploadBtn.addEventListener('click', async () => {
  const fileInput = form.elements['imagefile']
  const file = fileInput.files[0]
  if (!file) { alert('Choisissez d\'abord un fichier'); return }

  const fileName = `${Date.now()}_${file.name.replace(/\s+/g,'_')}`
  uploadStatus.innerText = 'Upload en cours...'

  const { data, error } = await supabase.storage.from('photos-recettes').upload(fileName, file)
  if (error) { console.error(error); uploadStatus.innerText='Erreur lors de l\'upload'; return }

  uploadedPath = data.path
  const { data: publicUrlData } = supabase.storage.from('photos-recettes').getPublicUrl(uploadedPath)
  form.elements['photo_url'].value = publicUrlData.publicUrl
  uploadStatus.innerText = 'Upload réussi !'
})

// ===== Charger la liste =====
async function loadList() {
  const { data, error } = await supabase.from('recettes').select('*').order('created_at', { ascending:false })
  if (error) { console.error(error); listDiv.innerHTML='<p>Erreur de chargement des recettes.</p>'; return }

  listDiv.innerHTML = ''
  data.forEach(r => {
    const card = document.createElement('div')
    card.className = 'card'
    card.style.padding='12px'
    card.style.marginBottom='10px'
    card.innerHTML = `
      <strong>${r.titre}</strong> — ${r.categorie} <br/>
      <button data-id="${r.id}" class="edit">Modifier</button>
      <button data-id="${r.id}" class="del">Supprimer</button>
    `
    listDiv.appendChild(card)
  })

  // ===== Suppression =====
  listDiv.querySelectorAll('.del').forEach(btn => {
    btn.addEventListener('click', async e => {
      const id = e.target.dataset.id
      await deleteRecette(id)
    })
  })

  // ===== Édition =====
  listDiv.querySelectorAll('.edit').forEach(btn => {
    btn.addEventListener('click', async e => {
      const id = e.target.dataset.id
      const { data, error } = await supabase.from('recettes').select('*').eq('id', id).single()
      if (error || !data) { alert('Recette introuvable'); return }

      form.elements['id'].value = data.id
      form.elements['titre'].value = data.titre || ''
      form.elements['description'].value = data.description || ''
      form.elements['categorie'].value = data.categorie || 'dessert'
      form.elements['photo_url'].value = data.photo_url || ''
      form.elements['lien_youtube'].value = data.lien_youtube || ''
      form.elements['ingredients'].value = (data.ingredients||[]).join('\n')
      form.elements['preparation'].value = (data.preparation||[]).join('\n')
    })
  })
}

// ===== Supprimer recette + image =====
async function deleteRecette(id) {
  if (!confirm("Voulez-vous vraiment supprimer cette recette ?")) return;

  try {
    const { data: recette, error: getError } = await supabase
      .from('recettes').select('photo_url').eq('id', id).single()
    if (getError) throw getError

    const { error: deleteError } = await supabase.from('recettes').delete().eq('id', id)
    if (deleteError) throw deleteError

    if (recette?.photo_url) {
      const path = recette.photo_url.split('/o/')[1].split('?')[0]
      const { error: storageError } = await supabase.storage.from('photos-recettes').remove([decodeURIComponent(path)])
      if (storageError) console.warn("Image non supprimée :", storageError.message)
    }

    alert("Recette supprimée avec succès !")
    loadList()
  } catch (err) {
    console.error(err)
    alert("Erreur lors de la suppression")
  }
}

// ===== Soumission formulaire =====
form.addEventListener('submit', async e => {
  e.preventDefault()
  const id = form.elements['id'].value || null
  const recette = {
    titre: form.elements['titre'].value,
    description: form.elements['description'].value,
    categorie: form.elements['categorie'].value,
    photo_url: form.elements['photo_url'].value || null,
    lien_youtube: form.elements['lien_youtube'].value || null,
    ingredients: form.elements['ingredients'].value
      ? form.elements['ingredients'].value.split('\n').map(i=>i.trim()).filter(Boolean)
      : [],
    preparation: form.elements['preparation'].value
      ? form.elements['preparation'].value.split('\n').map(s=>s.trim()).filter(Boolean)
      : []
  }

  try {
    if (id) {
      // Récupérer ancienne image si remplacée
      const { data: ancienne, error: getOld } = await supabase.from('recettes').select('photo_url').eq('id', id).single()
      if (getOld) throw getOld

      if (uploadedPath && ancienne?.photo_url) {
        const oldPath = ancienne.photo_url.split('/o/')[1].split('?')[0]
        await supabase.storage.from('photos-recettes').remove([decodeURIComponent(oldPath)])
      }

      const { error: updateError } = await supabase.from('recettes').update(recette).eq('id', id)
      if (updateError) throw updateError
      alert('Recette mise à jour')
    } else {
      const { error: insertError } = await supabase.from('recettes').insert(recette)
      if (insertError) throw insertError
      alert('Recette créée')
    }

    form.reset()
    uploadedPath = ''
    uploadStatus.innerText = ''
    loadList()
  } catch(err) {
    console.error(err)
    alert("Erreur lors de l'enregistrement")
  }
})

// ===== Réinitialiser formulaire =====
document.getElementById('resetBtn').addEventListener('click', ()=>{
  form.reset()
  uploadedPath = ''
  uploadStatus.innerText = ''
})

loadList()
</script>
