<script type="module">

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// Mets ici ton URL et ta clé d'API Supabase (remplace par les tiennes)
const supabaseUrl = 'https://ttkgzzamsfnittbqqvft.supabase.co'
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInJlZiI6InR0a2d6emFtc2ZuaXR0YnFxdmZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4Mjg4MTEsImV4cCI6MjA3MDQwNDgxMX0.aE5GxrKrNJoqr1g8ASVG9Vdf7k_OLuyCOe2vZAp0-wY'

const supabase = createClient(supabaseUrl, supabaseKey)

const form = document.getElementById('recipeForm')
const listDiv = document.getElementById('list')
const uploadBtn = document.getElementById('uploadBtn')
const uploadStatus = document.getElementById('uploadStatus')

let uploadedPath = ''

// === Upload image ===
uploadBtn.addEventListener('click', async () => {
  const fileInput = form.elements['imagefile']
  const file = fileInput.files[0]
  if (!file) {
    alert('Choisissez d\'abord un fichier')
    return
  }

  const fileName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`
  uploadStatus.innerText = 'Upload en cours...'

  const { data, error } = await supabase.storage.from('photos-recettes').upload(fileName, file)
  if (error) {
    console.error('Erreur upload :', error)
    uploadStatus.innerText = 'Erreur lors de l\'upload'
    return
  }

  uploadedPath = data.path
  const { data: publicUrlData } = supabase.storage.from('photos-recettes').getPublicUrl(uploadedPath)
  form.elements['photo_url'].value = publicUrlData.publicUrl
  uploadStatus.innerText = 'Upload réussi !'
})

// === Charger liste des recettes ===
async function loadList() {
  const { data, error } = await supabase.from('recettes').select('*').order('created_at', { ascending: false })
  if (error) {
    console.error('Erreur chargement recettes:', error)
    listDiv.innerHTML = '<p>Erreur de chargement des recettes.</p>'
    return
  }

  listDiv.innerHTML = ''
  data.forEach(r => {
    const card = document.createElement('div')
    card.className = 'card'
    card.style.padding = '12px'
    card.style.marginBottom = '10px'
    card.innerHTML = `
      <strong>${r.titre}</strong> — ${r.categorie} <br/>
      <button data-id="${r.id}" class="edit">Modifier</button>
      <button data-id="${r.id}" class="del">Supprimer</button>
    `
    listDiv.appendChild(card)
  })

  // Suppression
  listDiv.querySelectorAll('.del').forEach(btn => {
    btn.addEventListener('click', async e => {
      if (!confirm('Supprimer cette recette ?')) return
      const id = e.target.dataset.id
      const { error } = await supabase.from('recettes').delete().eq('id', id)
      if (error) {
        alert('Erreur lors de la suppression')
        console.error(error)
      } else {
        loadList()
      }
    })
  })

  // Édition
  listDiv.querySelectorAll('.edit').forEach(btn => {
    btn.addEventListener('click', async e => {
      const id = e.target.dataset.id
      const { data, error } = await supabase.from('recettes').select('*').eq('id', id).single()
      if (error || !data) {
        alert('Recette introuvable')
        return
      }
      form.elements['id'].value = data.id
      form.elements['titre'].value = data.titre || ''
      form.elements['description'].value = data.description || ''
      form.elements['categorie'].value = data.categorie || 'dessert'
      form.elements['photo_url'].value = data.photo_url || ''
      form.elements['lien_youtube'].value = data.lien_youtube || ''
      form.elements['ingredients'].value = (data.ingredients || []).join('\n')
      form.elements['preparation'].value = (data.preparation || []).join('\n')
    })
  })
}

// === Sauvegarde recette ===
form.addEventListener('submit', async e => {
  e.preventDefault()
  const id = form.elements['id'].value || null
  const recette = {
    titre: form.elements['titre'].value,
    description: form.elements['description'].value,
    categorie: form.elements['categorie'].value,
    photo_url: form.elements['photo_url'].value || null,
    lien_youtube: form.elements['lien_youtube'].value || null,
    ingredients: form.elements['ingredients'].value
      ? form.elements['ingredients'].value.split('\n').map(i => i.trim()).filter(Boolean)
      : [],
    preparation: form.elements['preparation'].value
      ? form.elements['preparation'].value.split('\n').map(s => s.trim()).filter(Boolean)
      : []
  }

  let response
  if (id) {
    response = await supabase.from('recettes').update(recette).eq('id', id)
  } else {
    response = await supabase.from('recettes').insert(recette)
  }

  if (response.error) {
    alert('Erreur lors de la sauvegarde')
    console.error(response.error)
    return
  }

  alert(id ? 'Recette mise à jour' : 'Recette créée')
  form.reset()
  uploadedPath = ''
  uploadStatus.innerText = ''
  loadList()
})

document.getElementById('resetBtn').addEventListener('click', () => {
  form.reset()
  uploadedPath = ''
  uploadStatus.innerText = ''
})

loadList()

// === TEST ENVOI EMAIL via supabase.functions.invoke ===
const sendBtn = document.getElementById('sendTestEmail')
const emailInput = document.getElementById('testEmail')
const emailStatus = document.getElementById('emailStatus')

sendBtn.addEventListener('click', async () => {
  const recipient = emailInput.value.trim()
  if (!recipient) {
    alert('Veuillez entrer une adresse email')
    return
  }

  emailStatus.innerText = 'Envoi en cours...'

  try {
    const { data, error } = await supabase.functions.invoke('sendEmail', {
      method: 'POST',
      body: JSON.stringify({
        to: recipient,
        subject: 'Objet test',
        text: 'Test envoi email camijote'
      })
    })

    if (error) {
      emailStatus.innerText = 'Erreur : ' + error.message
      console.error(error)
    } else {
      emailStatus.innerText = 'Email envoyé avec succès !'
      console.log(data)
    }
  } catch (err) {
    emailStatus.innerText = 'Erreur lors de la requête'
    console.error(err)
  }
})
</script>
