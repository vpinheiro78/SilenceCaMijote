<!doctype html>
<html lang="fr">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Recette</title>
<link rel="stylesheet" href="style.css"/></head>
<body>
<header class="site-header"><h1>Silence, ça mijote</h1><a class="admin-link" href="admin/login.html"><img src="assets/logo.svg" alt="logo"/></a></header>
<main style="max-width:900px;margin:20px auto;padding:12px" id="main">
  <div id="detail-area"></div>
</main>
<footer class="site-footer">© 2025 Silence, ça mijote</footer>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
import { https://ttkgzzamsfnittbqqvft.supabase.co, eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0a2d6emFtc2ZuaXR0YnFxdmZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4Mjg4MTEsImV4cCI6MjA3MDQwNDgxMX0.aE5GxrKrNJoqr1g8ASVG9Vdf7k_OLuyCOe2vZAp0-wY } from './config.js'
const supabase = createClient(https://ttkgzzamsfnittbqqvft.supabase.co, eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR0a2d6emFtc2ZuaXR0YnFxdmZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4Mjg4MTEsImV4cCI6MjA3MDQwNDgxMX0.aE5GxrKrNJoqr1g8ASVG9Vdf7k_OLuyCOe2vZAp0-wY)

function starHtml(avg){ const full = Math.round(Number(avg)||0); return '★'.repeat(full) + '☆'.repeat(Math.max(0,5-full)); }

function getParam(name){ return new URLSearchParams(location.search).get(name) }

function photoUrlFromRow(r){
  const p = r.photo_url || r.image_url || r.photo || r.image || ''
  if(!p) return 'assets/placeholder.jpg'
  if(p.startsWith('http')) return p
  if(p.indexOf('/storage/v1')!==-1) return p
  return `${https://ttkgzzamsfnittbqqvft.supabase.co}/storage/v1/object/public/photos-recettes/${p}`
}

async function load(){
  const id = getParam('id')
  if(!id){ document.getElementById('detail-area').innerText = 'Recette introuvable'; return }
  let { data, error } = await supabase.from('recettes_avec_notes').select('*').eq('id', id).single()
  if(error || !data){ const r = await supabase.from('recettes').select('*').eq('id', id).single(); data = r.data }
  if(!data){ document.getElementById('detail-area').innerText = 'Recette introuvable'; return }
  const r = data
  const photo = photoUrlFromRow(r)
  const avg = r.moyenne_notes ?? r.note_moyenne ?? 0
  document.getElementById('detail-area').innerHTML = `
    <article class="card">
      <img src="${photo}" alt="${r.titre}"/>
      <div class="content">
        <h2>${r.titre}</h2>
        <div class="rating"><span class="stars">${starHtml(avg)}</span> <strong>(${(Number(avg)||0).toFixed(1)})</strong></div>
        <p><em>${r.description||''}</em></p>
        <h3>Ingrédients</h3>
        <ul>${(r.ingredients||[]).map(i=>`<li>${i}</li>`).join('')}</ul>
        <h3>Préparation</h3>
        <ol>${(r.preparation||[]).map(s=>`<li>${s}</li>`).join('')}</ol>
        ${r.lien_video?`<h3>Vidéo</h3><div><iframe width="100%" height="320" src="${r.lien_video.replace('watch?v=','embed/')}" frameborder="0" allowfullscreen></iframe></div>`:''}
        <div style="margin-top:12px"><button onclick="history.back()">← Retour</button></div>
      </div>
    </article>
  `

  // Rating buttons
  const voteRow = document.createElement('div')
  voteRow.style.marginTop = '12px'
  voteRow.innerHTML = '<strong>Votre note :</strong> ' + [1,2,3,4,5].map(n=>`<button data-n="${n}" class="vote-btn">${n}★</button>`).join(' ')
  document.getElementById('detail-area').appendChild(voteRow)
  voteRow.querySelectorAll('.vote-btn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const val = parseInt(btn.dataset.n)
      await supabase.from('notes').insert({recette_id: id, note: val})
      const { data: updated } = await supabase.from('recettes_avec_notes').select('*').eq('id', id).single()
      if(updated){
        document.querySelector('.rating .stars').innerText = starHtml(updated.moyenne_notes)
        document.querySelector('.rating strong').innerText = '(' + (updated.moyenne_notes||0).toFixed(1) + ')'
      }
    })
  })
}

load()
</script>
</body>
</html>
